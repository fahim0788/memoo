services:
  # ===========================================================================
  # Nginx Reverse Proxy
  # ===========================================================================
  nginx:
    image: nginx:1.25-alpine
    ports:
      - "80:80"
    volumes:
      - ./infra/nginx/${NGINX_CONF:-nginx.local.conf}:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
      - api
    restart: unless-stopped

  # ===========================================================================
  # Frontend Web (Next.js PWA)
  # ===========================================================================
  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
      args:
        # DEV: Utiliser http://localhost:3001/api pour que STORAGE_BASE fonctionne
        # PROD: Utiliser /api (nginx gère le routing)
        NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-http://localhost:3001/api}
        NEXT_PUBLIC_APP_NAME: ${NEXT_PUBLIC_APP_NAME:-MemoList}
    ports:
      - "3000:3000"
    depends_on:
      - api
    restart: unless-stopped

  # ===========================================================================
  # Backend API (Next.js + Prisma)
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: ./apps/api/Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ORIGIN=${CORS_ORIGIN:-https://memoo.fr}
      - STORAGE_TYPE=${STORAGE_TYPE:-local}
      - TTS_STORAGE_PATH=/app/storage/tts
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio}
      - MINIO_PORT=${MINIO_PORT:-9000}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-false}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-memolist-tts}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - BREVO_API_KEY=${BREVO_API_KEY:-}
    volumes:
      - tts-storage:/app/storage/tts
      - ./apps/worker/storage/drapeaux:/app/apps/worker/storage/drapeaux:ro
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  # ===========================================================================
  # TTS Worker (Background job processor)
  # ===========================================================================
  worker:
    build:
      context: .
      dockerfile: ./apps/worker/Dockerfile
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - STORAGE_TYPE=${STORAGE_TYPE:-local}
      - LOCAL_STORAGE_PATH=/app/storage/tts
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-http://localhost:3001/storage/tts}
      - POLL_INTERVAL_MS=5000
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio}
      - MINIO_PORT=${MINIO_PORT:-9000}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-false}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-memolist-tts}
    volumes:
      - tts-storage:/app/storage/tts
      - ./apps/worker/storage/input:/app/storage/input:ro
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  db:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-memolist}
      - POSTGRES_USER=${POSTGRES_USER:-memolist}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-memolist}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-memolist}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===========================================================================
  # MinIO Object Storage
  # ===========================================================================
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console web
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Init MinIO buckets au premier démarrage
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing myminio/memolist-tts;
      mc mb --ignore-existing myminio/memolist-flags;
      mc anonymous set download myminio/memolist-tts;
      mc anonymous set download myminio/memolist-flags;
      echo 'MinIO buckets ready!';
      "
    restart: "no"

  # ===========================================================================
  # Database Backups (daily at 03:00)
  # ===========================================================================
  db-backup:
    image: postgres:16-alpine
    entrypoint: /bin/sh
    command: >
      -c "
      echo '0 3 * * * /backup/pg-backup.sh >> /var/log/backup.log 2>&1' | crontab - &&
      crond -f -l 2
      "
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-memolist}
      - POSTGRES_USER=${POSTGRES_USER:-memolist}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-memolist}
    volumes:
      - ./infra/backup/pg-backup.sh:/backup/pg-backup.sh:ro
      - pgbackups:/backups
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

volumes:
  pgdata:
  tts-storage:
  minio-data:
  pgbackups:
